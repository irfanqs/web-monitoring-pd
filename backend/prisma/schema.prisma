generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SystemRole {
  admin
  supervisor
  employee
}

enum EmployeeRole {
  VER      // Verifikator
  PPRBPD   // Petugas Pembuat Rincian Biaya Perjalanan Dinas
  OK       // Operator Komitmen
  BP       // Bendahara Pengeluaran
  OP       // Operator Pembayaran
  PPK      // Pejabat Pembuat Komitmen
  PPD      // Pelaksana Perjalanan Dinas
  ADK      // Admin Digit Kemenkeu
  KSBU     // Kepala Sub Bagian Umum
  PABPD    // Petugas Arsip Berkas Perjalanan Dinas
  OSPM     // Operator SPM (Step 4)
  OSPBy    // Operator SPBy (Step 9)
}

enum TicketStatus {
  pending
  in_progress
  completed
}

model User {
  id           String        @id @default(cuid())
  username     String        @unique
  password     String
  name         String
  systemRole   SystemRole    @map("system_role")
  employeeRole EmployeeRole? @map("employee_role")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  createdTickets     Ticket[]        @relation("CreatedTickets")
  assignedPpdTickets Ticket[]        @relation("AssignedPpdTickets")
  ticketHistories    TicketHistory[]

  @@map("users")
}

model Ticket {
  id                     String       @id @default(cuid())
  ticketNumber           String       @unique @map("ticket_number")
  activityName           String       @map("activity_name")
  assignmentLetterNumber String       @map("assignment_letter_number")
  uraian                 String?      // Optional description field
  startDate              DateTime     @map("start_date") // Tanggal mulai perjalanan dinas
  isLs                   Boolean      @default(false) @map("is_ls")
  currentStep            Int          @default(1) @map("current_step")
  status                 TicketStatus @default(pending)
  assignedPpdUserId      String?      @map("assigned_ppd_user_id") // Assigned PPD user for step 12
  createdById            String       @map("created_by_id")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")

  createdBy      User            @relation("CreatedTickets", fields: [createdById], references: [id])
  assignedPpdUser User?          @relation("AssignedPpdTickets", fields: [assignedPpdUserId], references: [id])
  histories      TicketHistory[]

  @@map("tickets")
}

model TicketHistory {
  id            String   @id @default(cuid())
  ticketId      String   @map("ticket_id")
  stepNumber    Int      @map("step_number")
  processedById String   @map("processed_by_id")
  processorName String   @map("processor_name")
  fileUrl       String?  @map("file_url")
  fileName      String?  @map("file_name")
  notes         String?
  processedAt   DateTime @map("processed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  ticket      Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  processedBy User   @relation(fields: [processedById], references: [id])

  @@map("ticket_histories")
}

model StepConfiguration {
  id                   Int          @id @default(autoincrement())
  stepNumber           Int          @unique @map("step_number")
  stepName             String       @map("step_name")
  requiredEmployeeRole EmployeeRole @map("required_employee_role")
  description          String?
  isLsOnly             Boolean      @default(false) @map("is_ls_only")
  isNonLsOnly          Boolean      @default(false) @map("is_non_ls_only")
  isParallel           Boolean      @default(false) @map("is_parallel")
  parallelGroup        String?      @map("parallel_group")  // Steps with same group run in parallel

  @@map("step_configurations")
}

model AppSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("app_settings")
}
